# Mall-Go æ”¯ä»˜ç³»ç»Ÿé…ç½®å®Œå–„æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®Œå–„äº†Mall-Goæ”¯ä»˜ç³»ç»Ÿçš„é…ç½®ç®¡ç†ï¼Œæ–°å¢äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **é…ç½®æ¨¡æ¿ç®¡ç†** - ä¸ºä¸åŒç¯å¢ƒæä¾›æ ‡å‡†åŒ–é…ç½®æ¨¡æ¿
2. **æ™ºèƒ½æ”¯ä»˜è·¯ç”±** - è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ”¯ä»˜æ–¹å¼
3. **æ€§èƒ½ç›‘æ§ç³»ç»Ÿ** - å®æ—¶ç›‘æ§æ”¯ä»˜ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
4. **é…ç½®éªŒè¯å·¥å…·** - ç¡®ä¿é…ç½®æ­£ç¡®æ€§å’Œå®‰å…¨æ€§
5. **å‘½ä»¤è¡Œé…ç½®å·¥å…·** - ä¾¿äºé…ç½®ç®¡ç†å’Œè¿ç»´

## ğŸš€ æ–°å¢æ–‡ä»¶åˆ—è¡¨

```
pkg/payment/
â”œâ”€â”€ template.go      # é…ç½®æ¨¡æ¿ç®¡ç†
â”œâ”€â”€ router.go        # æ™ºèƒ½æ”¯ä»˜è·¯ç”±
â”œâ”€â”€ metrics.go       # æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
â”œâ”€â”€ service.go       # ä¸šåŠ¡æœåŠ¡å±‚ï¼ˆå¢å¼ºç‰ˆï¼‰
â””â”€â”€ tool.go          # é…ç½®ç®¡ç†å·¥å…·

cmd/payment-config/
â””â”€â”€ main.go          # å‘½ä»¤è¡Œé…ç½®å·¥å…·
```

## ğŸ› ï¸ åŠŸèƒ½ç‰¹æ€§

### 1. é…ç½®æ¨¡æ¿ç®¡ç†

æ”¯æŒä¸‰ç§ç¯å¢ƒçš„é…ç½®æ¨¡æ¿ï¼š

- **å¼€å‘ç¯å¢ƒ (dev)** - æ²™ç®±ç¯å¢ƒï¼Œè°ƒè¯•æ¨¡å¼å¼€å¯
- **æµ‹è¯•ç¯å¢ƒ (test)** - æ›´çœŸå®çš„é…ç½®ï¼Œä»ä½¿ç”¨æ²™ç®±
- **ç”Ÿäº§ç¯å¢ƒ (prod)** - ç”Ÿäº§çº§é…ç½®ï¼Œå®‰å…¨æ€§æœ€é«˜

#### ä½¿ç”¨ç¤ºä¾‹ï¼š
```go
// è·å–å¼€å‘ç¯å¢ƒé…ç½®æ¨¡æ¿
config := payment.GetDevelopmentTemplate()

// éªŒè¯é…ç½®
errors := payment.ValidateEnvironmentConfig(config)
if len(errors) > 0 {
    // å¤„ç†éªŒè¯é”™è¯¯
}
```

### 2. æ™ºèƒ½æ”¯ä»˜è·¯ç”±

æ ¹æ®é‡‘é¢ã€ç”¨æˆ·åå¥½ç­‰å› ç´ æ™ºèƒ½æ¨èæ”¯ä»˜æ–¹å¼ï¼š

```go
router := payment.NewPaymentRouter(config)

// è·å–æ¨èæ”¯ä»˜æ–¹å¼
method := router.GetRecommendedMethod(
    decimal.NewFromFloat(299.99), 
    userID,
)

// åˆ›å»ºæ”¯ä»˜
response, err := router.CreatePayment(&payment.CreatePaymentRequest{
    OutTradeNo: "ORDER_123456",
    Amount:     decimal.NewFromFloat(299.99),
    Subject:    "å•†å“è´­ä¹°",
    Method:     method,
    UserID:     userID,
})
```

### 3. æ€§èƒ½ç›‘æ§

å®æ—¶ç›‘æ§æ”¯ä»˜ç³»ç»Ÿæ€§èƒ½ï¼š

```go
// è·å–æ€§èƒ½æŒ‡æ ‡
metrics := service.GetMetrics()

// è¾“å‡ºæŒ‡æ ‡æ‘˜è¦åˆ°æ—¥å¿—
service.LogSummary()

// è‡ªåŠ¨åŒ–å‘¨æœŸæ€§ç›‘æ§ï¼ˆæ¯5åˆ†é’Ÿï¼‰
metrics.StartPeriodicLogging(5 * time.Minute)
```

### 4. å‘½ä»¤è¡Œé…ç½®å·¥å…·

ä¾¿äºé…ç½®ç®¡ç†çš„CLIå·¥å…·ï¼š

#### ç”Ÿæˆé…ç½®æ–‡ä»¶
```bash
# ç”Ÿæˆå¼€å‘ç¯å¢ƒé…ç½®
./payment-config -cmd=generate -env=dev

# ç”Ÿæˆç”Ÿäº§ç¯å¢ƒé…ç½®
./payment-config -cmd=generate -env=prod -force
```

#### éªŒè¯é…ç½®
```bash
# éªŒè¯é…ç½®æ–‡ä»¶
./payment-config -cmd=validate

# JSONæ ¼å¼è¾“å‡º
./payment-config -cmd=validate -output=json
```

#### é…ç½®æ¯”è¾ƒ
```bash
# æ¯”è¾ƒä¸¤ä¸ªé…ç½®æ–‡ä»¶
./payment-config -cmd=compare -compare-with=./config/prod.json
```

#### å¤‡ä»½ç®¡ç†
```bash
# åˆ—å‡ºå¤‡ä»½æ–‡ä»¶
./payment-config -cmd=backup

# æ¢å¤é…ç½®
./payment-config -cmd=restore -backup=payment_20240101_120000.json
```

## ğŸ“Š æ€§èƒ½ç›‘æ§æŒ‡æ ‡

ç³»ç»Ÿè‡ªåŠ¨æ”¶é›†ä»¥ä¸‹æŒ‡æ ‡ï¼š

### æ”¯ä»˜åˆ›å»ºæŒ‡æ ‡
- æ€»è¯·æ±‚æ•°
- æˆåŠŸ/å¤±è´¥æ¬¡æ•°
- æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- P95/P99å“åº”æ—¶é—´

### æ”¯ä»˜æŸ¥è¯¢æŒ‡æ ‡
- æŸ¥è¯¢æ€»æ•°
- æŸ¥è¯¢æˆåŠŸç‡
- å¹³å‡æŸ¥è¯¢æ—¶é—´

### å›è°ƒå¤„ç†æŒ‡æ ‡
- å›è°ƒæ€»æ•°
- å›è°ƒæˆåŠŸç‡
- ç­¾åéªŒè¯å¤±è´¥æ¬¡æ•°

### ç³»ç»ŸæŒ‡æ ‡
- å½“å‰è¿æ¥æ•°
- æ€»è¯·æ±‚æ•°
- é”™è¯¯ç‡ç»Ÿè®¡

## ğŸ”§ é…ç½®æœ€ä½³å®è·µ

### 1. ç¯å¢ƒé…ç½®åˆ†ç¦»

```bash
# å¼€å‘ç¯å¢ƒ
PAYMENT_ENVIRONMENT=dev
ALIPAY_APP_ID=2021000000000000  # æ²™ç®±AppID
WECHAT_APP_ID=wx1234567890abcdef  # æµ‹è¯•AppID

# ç”Ÿäº§ç¯å¢ƒ
PAYMENT_ENVIRONMENT=prod
ALIPAY_APP_ID=2021001234567890  # æ­£å¼AppID
WECHAT_APP_ID=wxabcdef1234567890  # æ­£å¼AppID
```

### 2. å®‰å…¨é…ç½®

ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶è¦æ±‚ï¼š
- å¯ç”¨æ•°æ®åŠ å¯†
- é…ç½®IPç™½åå•
- ç¦ç”¨è°ƒè¯•æ¨¡å¼
- è®¾ç½®åˆç†çš„é™æµå‚æ•°

### 3. ç›‘æ§é…ç½®

```yaml
# ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®
Security:
  EnableSignature: true
  EnableEncrypt: true
  TokenExpiry: 1h
  MaxRequestSize: 512KB
  RateLimitRPS: 200
  AllowedIPs:
    - "110.75.143.101"  # æ”¯ä»˜å®å›è°ƒIP
    - "182.254.11.170"  # å¾®ä¿¡å›è°ƒIP
```

## ğŸš¨ è¿ç§»æŒ‡å—

### ä»æ—§é…ç½®è¿ç§»

1. **å¤‡ä»½ç°æœ‰é…ç½®**
```bash
cp config/payment.json config/payment.json.backup
```

2. **ç”Ÿæˆæ–°é…ç½®æ¨¡æ¿**
```bash
./payment-config -cmd=generate -env=prod
```

3. **è¿ç§»ç°æœ‰é…ç½®**
```bash
# æ‰‹åŠ¨è¿ç§»æˆ–ä½¿ç”¨è¿ç§»å·¥å…·
./payment-config -cmd=migrate -from=1.0 -to=1.1
```

4. **éªŒè¯æ–°é…ç½®**
```bash
./payment-config -cmd=validate
```

### ä»£ç æ›´æ–°

æ›´æ–°æ”¯ä»˜æœåŠ¡åˆå§‹åŒ–ï¼š

```go
// æ—§ç‰ˆæœ¬
service, err := payment.NewService(db, config)

// æ–°ç‰ˆæœ¬ - ä½¿ç”¨å¢å¼ºçš„é…ç½®ç³»ç»Ÿ
enhancedConfig := payment.LoadTemplateByEnvironment("prod")
router := payment.NewPaymentRouter(enhancedConfig)
service := payment.NewPaymentService(db, enhancedConfig)
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–
- ä¸ºæ”¯ä»˜è¡¨æ·»åŠ å¿…è¦çš„ç´¢å¼•
- å®šæœŸæ¸…ç†è¿‡æœŸçš„æ”¯ä»˜æ—¥å¿—
- ä½¿ç”¨è¯»å†™åˆ†ç¦»å‡è½»ä¸»åº“å‹åŠ›

### 2. ç¼“å­˜ç­–ç•¥
- ç¼“å­˜æ”¯ä»˜é…ç½®å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- ç¼“å­˜ç”¨æˆ·æ”¯ä»˜åå¥½
- ä½¿ç”¨Redisç¼“å­˜æ”¯ä»˜çŠ¶æ€

### 3. ç›‘æ§å‘Šè­¦
- è®¾ç½®æ”¯ä»˜æˆåŠŸç‡å‘Šè­¦ï¼ˆ< 95%ï¼‰
- è®¾ç½®å“åº”æ—¶é—´å‘Šè­¦ï¼ˆ> 5ç§’ï¼‰
- è®¾ç½®é”™è¯¯ç‡å‘Šè­¦ï¼ˆ> 1%ï¼‰

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **é…ç½®éªŒè¯å¤±è´¥**
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶
./payment-config -cmd=validate -output=json
```

2. **æ”¯ä»˜åˆ›å»ºå¤±è´¥**
```bash
# æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡
curl -X GET /api/v1/payment/metrics
```

3. **å›è°ƒéªŒè¯å¤±è´¥**
- æ£€æŸ¥IPç™½åå•é…ç½®
- éªŒè¯ç­¾åç®—æ³•
- æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

### æ—¥å¿—åˆ†æ

ç³»ç»Ÿè‡ªåŠ¨è®°å½•è¯¦ç»†æ—¥å¿—ï¼š
```
2024-01-01 12:00:00 INFO åˆ›å»ºæ”¯ä»˜è®¢å• method=alipay amount=99.99
2024-01-01 12:00:01 WARN åˆ›å»ºæ”¯ä»˜è¯·æ±‚å“åº”ç¼“æ…¢ duration=6s
2024-01-01 12:00:02 ERROR æ”¯ä»˜å›è°ƒç­¾åéªŒè¯å¤±è´¥ method=wechat
```

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **æ”¯æŒæ›´å¤šæ”¯ä»˜æ–¹å¼** - é“¶è”ã€æ•°å­—è´§å¸ç­‰
2. **é£æ§ç³»ç»Ÿé›†æˆ** - å®æ—¶é£é™©è¯„ä¼°
3. **å›½é™…åŒ–æ”¯æŒ** - æ”¯æŒæµ·å¤–æ”¯ä»˜æ¸ é“
4. **GraphQL API** - æä¾›æ›´çµæ´»çš„APIæ¥å£
5. **å¾®æœåŠ¡æ‹†åˆ†** - ç‹¬ç«‹æ”¯ä»˜æœåŠ¡

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. é¡¹ç›®Wikiæ–‡æ¡£
2. GitHub Issues
3. æŠ€æœ¯äº¤æµç¾¤

---

**æ³¨æ„**: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¯·åŠ¡å¿…ï¼š
1. å®Œæˆé…ç½®éªŒè¯
2. è¿›è¡Œå……åˆ†æµ‹è¯•
3. é…ç½®ç›‘æ§å‘Šè­¦
4. å‡†å¤‡å›æ»šæ–¹æ¡ˆ