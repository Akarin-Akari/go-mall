# Mall-Go测试用例设计模板

## 📋 测试用例模板说明

本文档提供Mall-Go电商系统的标准化测试用例设计模板，确保测试用例的一致性和完整性。

---

## 🧪 单元测试用例模板

### 后端Go单元测试模板

```go
// 文件: internal/handler/user/user_test.go
package user

import (
    "testing"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/suite"
)

// 测试套件结构
type UserHandlerTestSuite struct {
    suite.Suite
    handler *Handler
    mockDB  *gorm.DB
}

// 测试用例模板
func (suite *UserHandlerTestSuite) TestRegister() {
    // Given - 准备测试数据
    testCases := []struct {
        name           string
        input          RegisterRequest
        expectedStatus int
        expectedError  string
        setupMock      func()
    }{
        {
            name: "成功注册新用户",
            input: RegisterRequest{
                Username: "testuser",
                Email:    "test@example.com",
                Password: "password123",
            },
            expectedStatus: 200,
            expectedError:  "",
            setupMock: func() {
                // 设置Mock期望
            },
        },
        {
            name: "用户名已存在",
            input: RegisterRequest{
                Username: "existuser",
                Email:    "exist@example.com", 
                Password: "password123",
            },
            expectedStatus: 400,
            expectedError:  "用户名已存在",
            setupMock: func() {
                // 设置Mock返回用户已存在
            },
        },
    }

    // When & Then - 执行测试并验证结果
    for _, tc := range testCases {
        suite.Run(tc.name, func() {
            tc.setupMock()
            
            // 执行测试
            result := suite.handler.Register(tc.input)
            
            // 验证结果
            assert.Equal(suite.T(), tc.expectedStatus, result.Status)
            if tc.expectedError != "" {
                assert.Contains(suite.T(), result.Error, tc.expectedError)
            }
        })
    }
}
```

### 前端React单元测试模板

```typescript
// 文件: src/components/business/ProductCard.test.tsx
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { Provider } from 'react-redux';
import { configureStore } from '@reduxjs/toolkit';
import ProductCard from './ProductCard';
import { Product } from '@/types';

// 测试数据准备
const mockProduct: Product = {
  id: 1,
  name: '测试商品',
  price: '99.99',
  description: '这是一个测试商品',
  images: ['/test-image.jpg'],
  stock: 10,
};

// Mock Store配置
const createMockStore = (initialState = {}) => {
  return configureStore({
    reducer: {
      cart: (state = { items: [] }) => state,
      auth: (state = { isAuthenticated: true }) => state,
    },
    preloadedState: initialState,
  });
};

describe('ProductCard组件测试', () => {
  let mockStore: ReturnType<typeof createMockStore>;
  let mockOnAddToCart: jest.Mock;

  beforeEach(() => {
    mockStore = createMockStore();
    mockOnAddToCart = jest.fn();
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  test('应该正确渲染商品信息', () => {
    // Given
    render(
      <Provider store={mockStore}>
        <ProductCard 
          product={mockProduct} 
          onAddToCart={mockOnAddToCart}
        />
      </Provider>
    );

    // Then
    expect(screen.getByText('测试商品')).toBeInTheDocument();
    expect(screen.getByText('¥99.99')).toBeInTheDocument();
    expect(screen.getByText('这是一个测试商品')).toBeInTheDocument();
  });

  test('点击添加购物车按钮应该调用回调函数', async () => {
    // Given
    render(
      <Provider store={mockStore}>
        <ProductCard 
          product={mockProduct} 
          onAddToCart={mockOnAddToCart}
        />
      </Provider>
    );

    // When
    const addButton = screen.getByRole('button', { name: /添加到购物车/i });
    fireEvent.click(addButton);

    // Then
    await waitFor(() => {
      expect(mockOnAddToCart).toHaveBeenCalledWith(mockProduct);
    });
  });
});
```

---

## 🔗 集成测试用例模板

### API集成测试模板

```go
// 文件: tests/integration/user_api_test.go
package integration

import (
    "bytes"
    "encoding/json"
    "net/http"
    "net/http/httptest"
    "testing"
    
    "github.com/gin-gonic/gin"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/suite"
)

type UserAPITestSuite struct {
    suite.Suite
    router *gin.Engine
    db     *gorm.DB
}

func (suite *UserAPITestSuite) SetupSuite() {
    // 初始化测试数据库
    suite.db = setupTestDB()
    
    // 初始化路由
    suite.router = setupTestRouter(suite.db)
}

func (suite *UserAPITestSuite) TearDownSuite() {
    // 清理测试数据库
    cleanupTestDB(suite.db)
}

func (suite *UserAPITestSuite) TestUserRegistrationFlow() {
    testCases := []struct {
        name           string
        endpoint       string
        method         string
        payload        interface{}
        expectedStatus int
        expectedFields []string
        setupData      func()
        cleanupData    func()
    }{
        {
            name:     "用户注册成功",
            endpoint: "/api/v1/users/register",
            method:   "POST",
            payload: map[string]interface{}{
                "username": "newuser",
                "email":    "newuser@example.com",
                "password": "password123",
            },
            expectedStatus: 200,
            expectedFields: []string{"token", "user"},
            setupData:      func() {},
            cleanupData:    func() { suite.cleanupUser("newuser") },
        },
    }

    for _, tc := range testCases {
        suite.Run(tc.name, func() {
            // Setup
            tc.setupData()
            defer tc.cleanupData()

            // Prepare request
            jsonPayload, _ := json.Marshal(tc.payload)
            req := httptest.NewRequest(tc.method, tc.endpoint, bytes.NewBuffer(jsonPayload))
            req.Header.Set("Content-Type", "application/json")
            
            // Execute
            w := httptest.NewRecorder()
            suite.router.ServeHTTP(w, req)

            // Assert
            assert.Equal(suite.T(), tc.expectedStatus, w.Code)
            
            var response map[string]interface{}
            json.Unmarshal(w.Body.Bytes(), &response)
            
            for _, field := range tc.expectedFields {
                assert.Contains(suite.T(), response, field)
            }
        })
    }
}
```

---

## 🎭 端到端测试用例模板

### Cypress E2E测试模板

```typescript
// 文件: cypress/e2e/user-shopping-flow.cy.ts
describe('用户购物流程E2E测试', () => {
  beforeEach(() => {
    // 重置数据库状态
    cy.task('db:seed');
    
    // 访问首页
    cy.visit('/');
  });

  afterEach(() => {
    // 清理测试数据
    cy.task('db:cleanup');
  });

  it('完整的用户购物流程', () => {
    // Step 1: 用户注册
    cy.get('[data-testid="register-link"]').click();
    cy.get('[data-testid="username-input"]').type('testuser');
    cy.get('[data-testid="email-input"]').type('test@example.com');
    cy.get('[data-testid="password-input"]').type('password123');
    cy.get('[data-testid="register-button"]').click();
    
    // 验证注册成功
    cy.url().should('include', '/login');
    cy.contains('注册成功').should('be.visible');

    // Step 2: 用户登录
    cy.get('[data-testid="username-input"]').type('testuser');
    cy.get('[data-testid="password-input"]').type('password123');
    cy.get('[data-testid="login-button"]').click();
    
    // 验证登录成功
    cy.url().should('eq', Cypress.config().baseUrl + '/');
    cy.get('[data-testid="user-avatar"]').should('be.visible');

    // Step 3: 浏览商品
    cy.get('[data-testid="product-card"]').first().click();
    cy.url().should('include', '/products/');
    
    // Step 4: 添加到购物车
    cy.get('[data-testid="add-to-cart-button"]').click();
    cy.contains('已添加到购物车').should('be.visible');
    
    // Step 5: 查看购物车
    cy.get('[data-testid="cart-icon"]').click();
    cy.url().should('include', '/cart');
    cy.get('[data-testid="cart-item"]').should('have.length', 1);
    
    // Step 6: 结算下单
    cy.get('[data-testid="checkout-button"]').click();
    cy.url().should('include', '/checkout');
    
    // 填写收货地址
    cy.get('[data-testid="address-name"]').type('张三');
    cy.get('[data-testid="address-phone"]').type('13800138000');
    cy.get('[data-testid="address-detail"]').type('测试地址');
    
    // 选择支付方式
    cy.get('[data-testid="payment-alipay"]').click();
    
    // 提交订单
    cy.get('[data-testid="submit-order-button"]').click();
    
    // 验证订单创建成功
    cy.url().should('include', '/orders/');
    cy.contains('订单创建成功').should('be.visible');
  });

  it('购物车操作流程', () => {
    // 前置条件：用户已登录
    cy.login('testuser', 'password123');
    
    // 添加多个商品到购物车
    cy.visit('/products');
    cy.get('[data-testid="product-card"]').first().within(() => {
      cy.get('[data-testid="add-to-cart"]').click();
    });
    
    cy.get('[data-testid="product-card"]').eq(1).within(() => {
      cy.get('[data-testid="add-to-cart"]').click();
    });
    
    // 查看购物车
    cy.visit('/cart');
    cy.get('[data-testid="cart-item"]').should('have.length', 2);
    
    // 修改商品数量
    cy.get('[data-testid="quantity-input"]').first().clear().type('3');
    cy.get('[data-testid="update-quantity"]').first().click();
    
    // 验证总价更新
    cy.get('[data-testid="total-amount"]').should('contain', '297.00');
    
    // 删除商品
    cy.get('[data-testid="remove-item"]').first().click();
    cy.get('[data-testid="confirm-remove"]').click();
    
    // 验证商品已删除
    cy.get('[data-testid="cart-item"]').should('have.length', 1);
  });
});
```

---

## 📊 性能测试用例模板

### Go Benchmark测试模板

```go
// 文件: pkg/auth/jwt_test.go
package auth

import (
    "testing"
)

func BenchmarkGenerateToken(b *testing.B) {
    authService := NewAuthService("test-secret")
    user := &User{ID: 1, Username: "testuser"}
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        _, err := authService.GenerateToken(user)
        if err != nil {
            b.Fatal(err)
        }
    }
}

func BenchmarkValidateToken(b *testing.B) {
    authService := NewAuthService("test-secret")
    user := &User{ID: 1, Username: "testuser"}
    token, _ := authService.GenerateToken(user)
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        _, err := authService.ValidateToken(token)
        if err != nil {
            b.Fatal(err)
        }
    }
}
```

### Artillery负载测试配置模板

```yaml
# 文件: tests/performance/load-test.yml
config:
  target: 'http://localhost:8080'
  phases:
    - duration: 60
      arrivalRate: 10
      name: "预热阶段"
    - duration: 300
      arrivalRate: 50
      name: "负载测试"
    - duration: 120
      arrivalRate: 100
      name: "压力测试"
  defaults:
    headers:
      Content-Type: 'application/json'

scenarios:
  - name: "用户登录流程"
    weight: 30
    flow:
      - post:
          url: "/api/v1/users/login"
          json:
            username: "testuser"
            password: "password123"
          capture:
            - json: "$.token"
              as: "authToken"
      - get:
          url: "/api/v1/users/profile"
          headers:
            Authorization: "Bearer {{ authToken }}"

  - name: "商品查询流程"
    weight: 50
    flow:
      - get:
          url: "/api/v1/products"
          qs:
            page: 1
            page_size: 20
      - get:
          url: "/api/v1/products/{{ $randomInt(1, 100) }}"

  - name: "购物车操作流程"
    weight: 20
    flow:
      - post:
          url: "/api/v1/users/login"
          json:
            username: "testuser"
            password: "password123"
          capture:
            - json: "$.token"
              as: "authToken"
      - post:
          url: "/api/v1/cart/items"
          headers:
            Authorization: "Bearer {{ authToken }}"
          json:
            product_id: "{{ $randomInt(1, 100) }}"
            quantity: 1
```

---

## 📝 测试用例编写规范

### 命名规范
- **测试文件**: `{模块名}_test.{扩展名}`
- **测试函数**: `Test{功能名}_{场景描述}`
- **测试套件**: `{模块名}TestSuite`

### 测试结构规范
1. **Given** - 准备测试数据和环境
2. **When** - 执行被测试的操作
3. **Then** - 验证结果和断言

### 断言规范
- 使用明确的断言消息
- 验证关键业务逻辑
- 包含边界条件测试
- 覆盖异常情况

### 数据管理规范
- 每个测试用例独立的测试数据
- 测试前准备，测试后清理
- 使用工厂模式创建测试数据
- 避免测试用例间的数据依赖

---

**模板状态**: ✅ 完成  
**适用范围**: Mall-Go电商系统全模块  
**维护周期**: 每月更新一次
