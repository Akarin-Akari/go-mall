# Mall-Go测试环境搭建指南

## 📋 环境搭建概述

本指南详细说明如何为Mall-Go电商系统搭建完整的测试环境，包括单元测试、集成测试、E2E测试和性能测试环境。

---

## 🔧 基础环境要求

### 系统要求
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **内存**: 8GB+ (推荐16GB)
- **磁盘空间**: 20GB+
- **网络**: 稳定的互联网连接

### 必需软件版本
```bash
# Go环境
go version  # 要求 1.19+

# Node.js环境  
node --version  # 要求 18.0+
npm --version   # 要求 8.0+

# 数据库
mysql --version     # MySQL 8.0+ (可选)
sqlite3 --version   # SQLite 3.35+ (默认)

# Git版本控制
git --version  # 要求 2.30+
```

---

## 🏗️ 后端测试环境搭建

### 1. Go测试工具安装

```bash
# 安装测试相关依赖
go mod tidy

# 安装额外的测试工具
go install github.com/stretchr/testify@latest
go install github.com/golang/mock/mockgen@latest
go install github.com/onsi/ginkgo/v2/ginkgo@latest
go install github.com/onsi/gomega@latest

# 安装代码覆盖率工具
go install golang.org/x/tools/cmd/cover@latest
```

### 2. 测试数据库配置

#### SQLite测试数据库 (推荐)
```go
// tests/config/database.go
package config

import (
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "gorm.io/gorm/logger"
)

func SetupTestDB() *gorm.DB {
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{
        Logger: logger.Default.LogMode(logger.Silent),
    })
    if err != nil {
        panic("failed to connect test database")
    }
    
    // 自动迁移测试表
    err = db.AutoMigrate(
        &model.User{},
        &model.Product{},
        &model.Order{},
        &model.CartItem{},
    )
    if err != nil {
        panic("failed to migrate test database")
    }
    
    return db
}

func CleanupTestDB(db *gorm.DB) {
    sqlDB, _ := db.DB()
    sqlDB.Close()
}
```

#### MySQL测试数据库配置
```yaml
# configs/test.yml
database:
  driver: mysql
  host: localhost
  port: 3306
  username: test_user
  password: test_password
  database: mall_go_test
  charset: utf8mb4
  parseTime: true
  loc: Local
```

### 3. 测试配置文件

```go
// tests/config/config.go
package config

import (
    "os"
    "mall-go/internal/config"
)

func LoadTestConfig() {
    os.Setenv("GIN_MODE", "test")
    os.Setenv("DB_DRIVER", "sqlite")
    os.Setenv("DB_DSN", ":memory:")
    os.Setenv("JWT_SECRET", "test-secret-key")
    os.Setenv("LOG_LEVEL", "error")
    
    config.Load()
}
```

### 4. 测试辅助工具

```go
// tests/helpers/test_helper.go
package helpers

import (
    "bytes"
    "encoding/json"
    "net/http"
    "net/http/httptest"
    
    "github.com/gin-gonic/gin"
)

// HTTP测试辅助函数
func MakeRequest(router *gin.Engine, method, url string, body interface{}) *httptest.ResponseRecorder {
    var buf bytes.Buffer
    if body != nil {
        json.NewEncoder(&buf).Encode(body)
    }
    
    req := httptest.NewRequest(method, url, &buf)
    req.Header.Set("Content-Type", "application/json")
    
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    return w
}

// 认证Token生成
func GenerateTestToken(userID uint) string {
    // 生成测试用JWT Token
    return "test-jwt-token"
}

// 测试数据工厂
func CreateTestUser() *model.User {
    return &model.User{
        Username: "testuser",
        Email:    "test@example.com",
        Password: "hashedpassword",
    }
}
```

---

## ⚛️ 前端测试环境搭建

### 1. 测试工具安装

```bash
# 进入前端目录
cd mall-frontend

# 安装测试依赖
npm install --save-dev \
  jest \
  @testing-library/react \
  @testing-library/jest-dom \
  @testing-library/user-event \
  @types/jest \
  jest-environment-jsdom

# 安装E2E测试工具
npm install --save-dev cypress

# 安装API Mock工具
npm install --save-dev msw

# 安装代码覆盖率工具
npm install --save-dev @jest/coverage-reporter
```

### 2. Jest配置

```javascript
// jest.config.js
const nextJest = require('next/jest')

const createJestConfig = nextJest({
  dir: './',
})

const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  testEnvironment: 'jest-environment-jsdom',
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/app/layout.tsx',
    '!src/app/globals.css',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
  testMatch: [
    '<rootDir>/src/**/__tests__/**/*.{js,jsx,ts,tsx}',
    '<rootDir>/src/**/*.{test,spec}.{js,jsx,ts,tsx}',
  ],
}

module.exports = createJestConfig(customJestConfig)
```

### 3. 测试环境配置

```javascript
// jest.setup.js
import '@testing-library/jest-dom'
import { server } from './src/mocks/server'

// 启动MSW服务器
beforeAll(() => server.listen())
afterEach(() => server.resetHandlers())
afterAll(() => server.close())

// Mock Next.js router
jest.mock('next/navigation', () => ({
  useRouter() {
    return {
      push: jest.fn(),
      replace: jest.fn(),
      back: jest.fn(),
    }
  },
  useSearchParams() {
    return new URLSearchParams()
  },
}))

// Mock Redux store
jest.mock('@/store', () => ({
  useAppDispatch: () => jest.fn(),
  useAppSelector: jest.fn(),
}))
```

### 4. API Mock配置

```javascript
// src/mocks/handlers.js
import { rest } from 'msw'

export const handlers = [
  // 用户认证API
  rest.post('/api/v1/users/login', (req, res, ctx) => {
    return res(
      ctx.json({
        code: 200,
        msg: '登录成功',
        data: {
          token: 'mock-jwt-token',
          user: {
            id: 1,
            username: 'testuser',
            email: 'test@example.com',
          },
        },
      })
    )
  }),

  // 商品列表API
  rest.get('/api/v1/products', (req, res, ctx) => {
    return res(
      ctx.json({
        code: 200,
        msg: '获取成功',
        data: {
          list: [
            {
              id: 1,
              name: '测试商品1',
              price: '99.99',
              description: '这是测试商品1',
            },
          ],
          total: 1,
        },
      })
    )
  }),
]

// src/mocks/server.js
import { setupServer } from 'msw/node'
import { handlers } from './handlers'

export const server = setupServer(...handlers)
```

### 5. Cypress E2E配置

```javascript
// cypress.config.js
const { defineConfig } = require('cypress')

module.exports = defineConfig({
  e2e: {
    baseUrl: 'http://localhost:3001',
    supportFile: 'cypress/support/e2e.js',
    specPattern: 'cypress/e2e/**/*.cy.{js,jsx,ts,tsx}',
    video: true,
    screenshotOnRunFailure: true,
    viewportWidth: 1280,
    viewportHeight: 720,
    defaultCommandTimeout: 10000,
    requestTimeout: 10000,
    responseTimeout: 10000,
  },
  component: {
    devServer: {
      framework: 'next',
      bundler: 'webpack',
    },
  },
})
```

```javascript
// cypress/support/commands.js
Cypress.Commands.add('login', (username, password) => {
  cy.session([username, password], () => {
    cy.visit('/login')
    cy.get('[data-testid="username-input"]').type(username)
    cy.get('[data-testid="password-input"]').type(password)
    cy.get('[data-testid="login-button"]').click()
    cy.url().should('eq', Cypress.config().baseUrl + '/')
  })
})

Cypress.Commands.add('addToCart', (productId) => {
  cy.request({
    method: 'POST',
    url: '/api/v1/cart/items',
    headers: {
      Authorization: `Bearer ${window.localStorage.getItem('token')}`,
    },
    body: {
      product_id: productId,
      quantity: 1,
    },
  })
})
```

---

## 🚀 CI/CD集成配置

### GitHub Actions配置

```yaml
# .github/workflows/test.yml
name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: mall_go_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.19
    
    - name: Install dependencies
      run: |
        cd mall-go
        go mod download
    
    - name: Run tests
      run: |
        cd mall-go
        go test -v -race -coverprofile=coverage.out ./...
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./mall-go/coverage.out

  frontend-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        cache: 'npm'
        cache-dependency-path: mall-frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd mall-frontend
        npm ci
    
    - name: Run unit tests
      run: |
        cd mall-frontend
        npm run test:coverage
    
    - name: Run E2E tests
      run: |
        cd mall-frontend
        npm run build
        npm start &
        npx wait-on http://localhost:3001
        npm run cypress:run

  integration-test:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Start services
      run: |
        docker-compose -f docker-compose.test.yml up -d
    
    - name: Run integration tests
      run: |
        npm run test:integration
    
    - name: Stop services
      run: |
        docker-compose -f docker-compose.test.yml down
```

---

## 📊 测试执行脚本

### 后端测试脚本

```bash
#!/bin/bash
# scripts/test-backend.sh

echo "🚀 开始后端测试..."

# 进入后端目录
cd mall-go

# 运行单元测试
echo "📋 运行单元测试..."
go test -v -race ./internal/... ./pkg/...

# 运行集成测试
echo "🔗 运行集成测试..."
go test -v -tags=integration ./tests/integration/...

# 生成覆盖率报告
echo "📊 生成覆盖率报告..."
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# 运行性能测试
echo "⚡ 运行性能测试..."
go test -bench=. -benchmem ./...

echo "✅ 后端测试完成!"
```

### 前端测试脚本

```bash
#!/bin/bash
# scripts/test-frontend.sh

echo "🚀 开始前端测试..."

# 进入前端目录
cd mall-frontend

# 安装依赖
echo "📦 安装依赖..."
npm ci

# 运行单元测试
echo "🧪 运行单元测试..."
npm run test:coverage

# 运行E2E测试
echo "🎭 运行E2E测试..."
npm run build
npm start &
SERVER_PID=$!

# 等待服务启动
npx wait-on http://localhost:3001

# 运行Cypress测试
npm run cypress:run

# 停止服务
kill $SERVER_PID

echo "✅ 前端测试完成!"
```

---

## 🔍 测试数据管理

### 测试数据种子文件

```go
// tests/seeds/user_seed.go
package seeds

import "gorm.io/gorm"

func SeedUsers(db *gorm.DB) error {
    users := []model.User{
        {
            Username: "testuser1",
            Email:    "test1@example.com",
            Password: "hashedpassword1",
        },
        {
            Username: "testuser2", 
            Email:    "test2@example.com",
            Password: "hashedpassword2",
        },
    }
    
    return db.Create(&users).Error
}
```

### 数据清理工具

```go
// tests/helpers/cleanup.go
package helpers

import "gorm.io/gorm"

func CleanupDatabase(db *gorm.DB) error {
    tables := []string{
        "order_items",
        "orders", 
        "cart_items",
        "products",
        "users",
    }
    
    for _, table := range tables {
        if err := db.Exec("DELETE FROM " + table).Error; err != nil {
            return err
        }
    }
    
    return nil
}
```

---

## 📈 测试报告配置

### 覆盖率报告配置

```bash
# 生成详细的覆盖率报告
go test -coverprofile=coverage.out -covermode=atomic ./...
go tool cover -html=coverage.out -o coverage.html
go tool cover -func=coverage.out
```

### 测试结果输出格式

```bash
# 生成JUnit格式的测试报告
go install github.com/jstemmer/go-junit-report@latest
go test -v ./... | go-junit-report > test-results.xml
```

---

**环境搭建状态**: ✅ 完成  
**支持平台**: Windows/macOS/Linux  
**维护周期**: 每季度更新一次
