# Mall-Goæµ‹è¯•ç¯å¢ƒæ­å»ºæŒ‡å—

## ğŸ“‹ ç¯å¢ƒæ­å»ºæ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•ä¸ºMall-Goç”µå•†ç³»ç»Ÿæ­å»ºå®Œæ•´çš„æµ‹è¯•ç¯å¢ƒï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2Eæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ç¯å¢ƒã€‚

---

## ğŸ”§ åŸºç¡€ç¯å¢ƒè¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **å†…å­˜**: 8GB+ (æ¨è16GB)
- **ç£ç›˜ç©ºé—´**: 20GB+
- **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥

### å¿…éœ€è½¯ä»¶ç‰ˆæœ¬
```bash
# Goç¯å¢ƒ
go version  # è¦æ±‚ 1.19+

# Node.jsç¯å¢ƒ  
node --version  # è¦æ±‚ 18.0+
npm --version   # è¦æ±‚ 8.0+

# æ•°æ®åº“
mysql --version     # MySQL 8.0+ (å¯é€‰)
sqlite3 --version   # SQLite 3.35+ (é»˜è®¤)

# Gitç‰ˆæœ¬æ§åˆ¶
git --version  # è¦æ±‚ 2.30+
```

---

## ğŸ—ï¸ åç«¯æµ‹è¯•ç¯å¢ƒæ­å»º

### 1. Goæµ‹è¯•å·¥å…·å®‰è£…

```bash
# å®‰è£…æµ‹è¯•ç›¸å…³ä¾èµ–
go mod tidy

# å®‰è£…é¢å¤–çš„æµ‹è¯•å·¥å…·
go install github.com/stretchr/testify@latest
go install github.com/golang/mock/mockgen@latest
go install github.com/onsi/ginkgo/v2/ginkgo@latest
go install github.com/onsi/gomega@latest

# å®‰è£…ä»£ç è¦†ç›–ç‡å·¥å…·
go install golang.org/x/tools/cmd/cover@latest
```

### 2. æµ‹è¯•æ•°æ®åº“é…ç½®

#### SQLiteæµ‹è¯•æ•°æ®åº“ (æ¨è)
```go
// tests/config/database.go
package config

import (
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "gorm.io/gorm/logger"
)

func SetupTestDB() *gorm.DB {
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{
        Logger: logger.Default.LogMode(logger.Silent),
    })
    if err != nil {
        panic("failed to connect test database")
    }
    
    // è‡ªåŠ¨è¿ç§»æµ‹è¯•è¡¨
    err = db.AutoMigrate(
        &model.User{},
        &model.Product{},
        &model.Order{},
        &model.CartItem{},
    )
    if err != nil {
        panic("failed to migrate test database")
    }
    
    return db
}

func CleanupTestDB(db *gorm.DB) {
    sqlDB, _ := db.DB()
    sqlDB.Close()
}
```

#### MySQLæµ‹è¯•æ•°æ®åº“é…ç½®
```yaml
# configs/test.yml
database:
  driver: mysql
  host: localhost
  port: 3306
  username: test_user
  password: test_password
  database: mall_go_test
  charset: utf8mb4
  parseTime: true
  loc: Local
```

### 3. æµ‹è¯•é…ç½®æ–‡ä»¶

```go
// tests/config/config.go
package config

import (
    "os"
    "mall-go/internal/config"
)

func LoadTestConfig() {
    os.Setenv("GIN_MODE", "test")
    os.Setenv("DB_DRIVER", "sqlite")
    os.Setenv("DB_DSN", ":memory:")
    os.Setenv("JWT_SECRET", "test-secret-key")
    os.Setenv("LOG_LEVEL", "error")
    
    config.Load()
}
```

### 4. æµ‹è¯•è¾…åŠ©å·¥å…·

```go
// tests/helpers/test_helper.go
package helpers

import (
    "bytes"
    "encoding/json"
    "net/http"
    "net/http/httptest"
    
    "github.com/gin-gonic/gin"
)

// HTTPæµ‹è¯•è¾…åŠ©å‡½æ•°
func MakeRequest(router *gin.Engine, method, url string, body interface{}) *httptest.ResponseRecorder {
    var buf bytes.Buffer
    if body != nil {
        json.NewEncoder(&buf).Encode(body)
    }
    
    req := httptest.NewRequest(method, url, &buf)
    req.Header.Set("Content-Type", "application/json")
    
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    return w
}

// è®¤è¯Tokenç”Ÿæˆ
func GenerateTestToken(userID uint) string {
    // ç”Ÿæˆæµ‹è¯•ç”¨JWT Token
    return "test-jwt-token"
}

// æµ‹è¯•æ•°æ®å·¥å‚
func CreateTestUser() *model.User {
    return &model.User{
        Username: "testuser",
        Email:    "test@example.com",
        Password: "hashedpassword",
    }
}
```

---

## âš›ï¸ å‰ç«¯æµ‹è¯•ç¯å¢ƒæ­å»º

### 1. æµ‹è¯•å·¥å…·å®‰è£…

```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd mall-frontend

# å®‰è£…æµ‹è¯•ä¾èµ–
npm install --save-dev \
  jest \
  @testing-library/react \
  @testing-library/jest-dom \
  @testing-library/user-event \
  @types/jest \
  jest-environment-jsdom

# å®‰è£…E2Eæµ‹è¯•å·¥å…·
npm install --save-dev cypress

# å®‰è£…API Mockå·¥å…·
npm install --save-dev msw

# å®‰è£…ä»£ç è¦†ç›–ç‡å·¥å…·
npm install --save-dev @jest/coverage-reporter
```

### 2. Jesté…ç½®

```javascript
// jest.config.js
const nextJest = require('next/jest')

const createJestConfig = nextJest({
  dir: './',
})

const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  testEnvironment: 'jest-environment-jsdom',
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/app/layout.tsx',
    '!src/app/globals.css',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
  testMatch: [
    '<rootDir>/src/**/__tests__/**/*.{js,jsx,ts,tsx}',
    '<rootDir>/src/**/*.{test,spec}.{js,jsx,ts,tsx}',
  ],
}

module.exports = createJestConfig(customJestConfig)
```

### 3. æµ‹è¯•ç¯å¢ƒé…ç½®

```javascript
// jest.setup.js
import '@testing-library/jest-dom'
import { server } from './src/mocks/server'

// å¯åŠ¨MSWæœåŠ¡å™¨
beforeAll(() => server.listen())
afterEach(() => server.resetHandlers())
afterAll(() => server.close())

// Mock Next.js router
jest.mock('next/navigation', () => ({
  useRouter() {
    return {
      push: jest.fn(),
      replace: jest.fn(),
      back: jest.fn(),
    }
  },
  useSearchParams() {
    return new URLSearchParams()
  },
}))

// Mock Redux store
jest.mock('@/store', () => ({
  useAppDispatch: () => jest.fn(),
  useAppSelector: jest.fn(),
}))
```

### 4. API Mocké…ç½®

```javascript
// src/mocks/handlers.js
import { rest } from 'msw'

export const handlers = [
  // ç”¨æˆ·è®¤è¯API
  rest.post('/api/v1/users/login', (req, res, ctx) => {
    return res(
      ctx.json({
        code: 200,
        msg: 'ç™»å½•æˆåŠŸ',
        data: {
          token: 'mock-jwt-token',
          user: {
            id: 1,
            username: 'testuser',
            email: 'test@example.com',
          },
        },
      })
    )
  }),

  // å•†å“åˆ—è¡¨API
  rest.get('/api/v1/products', (req, res, ctx) => {
    return res(
      ctx.json({
        code: 200,
        msg: 'è·å–æˆåŠŸ',
        data: {
          list: [
            {
              id: 1,
              name: 'æµ‹è¯•å•†å“1',
              price: '99.99',
              description: 'è¿™æ˜¯æµ‹è¯•å•†å“1',
            },
          ],
          total: 1,
        },
      })
    )
  }),
]

// src/mocks/server.js
import { setupServer } from 'msw/node'
import { handlers } from './handlers'

export const server = setupServer(...handlers)
```

### 5. Cypress E2Eé…ç½®

```javascript
// cypress.config.js
const { defineConfig } = require('cypress')

module.exports = defineConfig({
  e2e: {
    baseUrl: 'http://localhost:3001',
    supportFile: 'cypress/support/e2e.js',
    specPattern: 'cypress/e2e/**/*.cy.{js,jsx,ts,tsx}',
    video: true,
    screenshotOnRunFailure: true,
    viewportWidth: 1280,
    viewportHeight: 720,
    defaultCommandTimeout: 10000,
    requestTimeout: 10000,
    responseTimeout: 10000,
  },
  component: {
    devServer: {
      framework: 'next',
      bundler: 'webpack',
    },
  },
})
```

```javascript
// cypress/support/commands.js
Cypress.Commands.add('login', (username, password) => {
  cy.session([username, password], () => {
    cy.visit('/login')
    cy.get('[data-testid="username-input"]').type(username)
    cy.get('[data-testid="password-input"]').type(password)
    cy.get('[data-testid="login-button"]').click()
    cy.url().should('eq', Cypress.config().baseUrl + '/')
  })
})

Cypress.Commands.add('addToCart', (productId) => {
  cy.request({
    method: 'POST',
    url: '/api/v1/cart/items',
    headers: {
      Authorization: `Bearer ${window.localStorage.getItem('token')}`,
    },
    body: {
      product_id: productId,
      quantity: 1,
    },
  })
})
```

---

## ğŸš€ CI/CDé›†æˆé…ç½®

### GitHub Actionsé…ç½®

```yaml
# .github/workflows/test.yml
name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: mall_go_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.19
    
    - name: Install dependencies
      run: |
        cd mall-go
        go mod download
    
    - name: Run tests
      run: |
        cd mall-go
        go test -v -race -coverprofile=coverage.out ./...
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./mall-go/coverage.out

  frontend-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        cache: 'npm'
        cache-dependency-path: mall-frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd mall-frontend
        npm ci
    
    - name: Run unit tests
      run: |
        cd mall-frontend
        npm run test:coverage
    
    - name: Run E2E tests
      run: |
        cd mall-frontend
        npm run build
        npm start &
        npx wait-on http://localhost:3001
        npm run cypress:run

  integration-test:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Start services
      run: |
        docker-compose -f docker-compose.test.yml up -d
    
    - name: Run integration tests
      run: |
        npm run test:integration
    
    - name: Stop services
      run: |
        docker-compose -f docker-compose.test.yml down
```

---

## ğŸ“Š æµ‹è¯•æ‰§è¡Œè„šæœ¬

### åç«¯æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# scripts/test-backend.sh

echo "ğŸš€ å¼€å§‹åç«¯æµ‹è¯•..."

# è¿›å…¥åç«¯ç›®å½•
cd mall-go

# è¿è¡Œå•å…ƒæµ‹è¯•
echo "ğŸ“‹ è¿è¡Œå•å…ƒæµ‹è¯•..."
go test -v -race ./internal/... ./pkg/...

# è¿è¡Œé›†æˆæµ‹è¯•
echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
go test -v -tags=integration ./tests/integration/...

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# è¿è¡Œæ€§èƒ½æµ‹è¯•
echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
go test -bench=. -benchmem ./...

echo "âœ… åç«¯æµ‹è¯•å®Œæˆ!"
```

### å‰ç«¯æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# scripts/test-frontend.sh

echo "ğŸš€ å¼€å§‹å‰ç«¯æµ‹è¯•..."

# è¿›å…¥å‰ç«¯ç›®å½•
cd mall-frontend

# å®‰è£…ä¾èµ–
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
npm ci

# è¿è¡Œå•å…ƒæµ‹è¯•
echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
npm run test:coverage

# è¿è¡ŒE2Eæµ‹è¯•
echo "ğŸ­ è¿è¡ŒE2Eæµ‹è¯•..."
npm run build
npm start &
SERVER_PID=$!

# ç­‰å¾…æœåŠ¡å¯åŠ¨
npx wait-on http://localhost:3001

# è¿è¡ŒCypressæµ‹è¯•
npm run cypress:run

# åœæ­¢æœåŠ¡
kill $SERVER_PID

echo "âœ… å‰ç«¯æµ‹è¯•å®Œæˆ!"
```

---

## ğŸ” æµ‹è¯•æ•°æ®ç®¡ç†

### æµ‹è¯•æ•°æ®ç§å­æ–‡ä»¶

```go
// tests/seeds/user_seed.go
package seeds

import "gorm.io/gorm"

func SeedUsers(db *gorm.DB) error {
    users := []model.User{
        {
            Username: "testuser1",
            Email:    "test1@example.com",
            Password: "hashedpassword1",
        },
        {
            Username: "testuser2", 
            Email:    "test2@example.com",
            Password: "hashedpassword2",
        },
    }
    
    return db.Create(&users).Error
}
```

### æ•°æ®æ¸…ç†å·¥å…·

```go
// tests/helpers/cleanup.go
package helpers

import "gorm.io/gorm"

func CleanupDatabase(db *gorm.DB) error {
    tables := []string{
        "order_items",
        "orders", 
        "cart_items",
        "products",
        "users",
    }
    
    for _, table := range tables {
        if err := db.Exec("DELETE FROM " + table).Error; err != nil {
            return err
        }
    }
    
    return nil
}
```

---

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Šé…ç½®

### è¦†ç›–ç‡æŠ¥å‘Šé…ç½®

```bash
# ç”Ÿæˆè¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out -covermode=atomic ./...
go tool cover -html=coverage.out -o coverage.html
go tool cover -func=coverage.out
```

### æµ‹è¯•ç»“æœè¾“å‡ºæ ¼å¼

```bash
# ç”ŸæˆJUnitæ ¼å¼çš„æµ‹è¯•æŠ¥å‘Š
go install github.com/jstemmer/go-junit-report@latest
go test -v ./... | go-junit-report > test-results.xml
```

---

**ç¯å¢ƒæ­å»ºçŠ¶æ€**: âœ… å®Œæˆ  
**æ”¯æŒå¹³å°**: Windows/macOS/Linux  
**ç»´æŠ¤å‘¨æœŸ**: æ¯å­£åº¦æ›´æ–°ä¸€æ¬¡
